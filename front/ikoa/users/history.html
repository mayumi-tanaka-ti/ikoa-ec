<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>購入履歴</title>
     <link rel="stylesheet" href="/src/css/history.css">
</head>
<body>
    <div class="container">
        <h1>購入履歴</h1>
        <div class="to-create">
            <a href="create.html">レビューを書く</a>
        </div>
        <table>
            <thead>
                <tr>
                    <th>注文ID</th>
                    <th>注文日</th>
                    <th>商品名</th>
                    <th>数量</th>
                    <th>金額</th>
                    <th>レビュー</th>
                </tr>
            </thead>
            <tbody id="historyBody">
            </tbody>
        </table>
    </div>
    <script>
    async function fetchHistory() {
        const token = localStorage.getItem('token');
        const res = await fetch('/api/history', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = '';
        if (Array.isArray(data) && data.length > 0) {
            data.forEach(order => {
                order.order_products.forEach(op => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${order.id}</td>
                        <td>${order.created_at ? order.created_at.substring(0, 10) : ''}</td>
                        <td>${op.product ? op.product.name : ''}</td>
                        <td>${op.quantity || ''}</td>
                        <td>${op.price || ''}</td>
                        <td><a class='review-link' href="create.html?product_id=${op.product ? op.product.id : ''}">レビューを書く</a></td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        } else {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="6">購入履歴がありません</td>';
            tbody.appendChild(tr);
        }
    }
    fetchHistory();
    </script>
</body>
</html>
