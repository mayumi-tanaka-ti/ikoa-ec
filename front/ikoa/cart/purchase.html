<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>購入手続き</title>
    <link rel="stylesheet" href="/src/css/purchase.css">
</head>
<body>
    <div class="container">
        <div class="back-link"><a href="/ikoa/products">← 買い物を続ける</a></div>
        <h1>購入手続き</h1>
        <div class="summary" id="cartSummary">
            <!-- カート内容をここに表示 -->
        </div>
        <form id="purchaseForm">
            <label for="address">お届け先住所</label>
            <input type="text" id="address" name="address" required>
            <label for="note">備考</label>
            <textarea id="note" name="note" rows="2"></textarea>
            <button type="submit">購入を確定する</button>
        </form>
        <div id="result" style="margin-top:1em;color:green;"></div>
    </div>
    <script>
    // カート内容を表示（例：localStorageやAPIから取得）
    async function showCart() {
        const token = localStorage.getItem('token');
        const res = await fetch('/api/cart', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        const summary = document.getElementById('cartSummary');
        if (Array.isArray(data) && data.length > 0) {
            let html = '<ul>';
            let total = 0;
            data.forEach(item => {
                html += `<li>${item.product ? item.product.name : ''} × ${item.quantity}：${item.amount_price}円</li>`;
                total += Number(item.amount_price);
            });
            html += `</ul><strong>合計：${total}円</strong>`;
            summary.innerHTML = html;
        } else {
            summary.innerHTML = 'カートに商品がありません。';
        }
    }
    showCart();

    document.getElementById('purchaseForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const address = document.getElementById('address').value;
        const note = document.getElementById('note').value;
        const token = localStorage.getItem('token');
        const res = await fetch('/api/cart/purchase', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ address, note })
        });
        const data = await res.json();
        if (res.ok) {
            document.getElementById('result').textContent = '購入が完了しました。';
            setTimeout(() => { window.location.href = 'complete.html'; }, 1500);
        } else {
            document.getElementById('result').textContent = data.message || 'エラーが発生しました';
        }
    });
    </script>
</body>
</html>
